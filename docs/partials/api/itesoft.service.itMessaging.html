<h1><code ng:non-bindable="">itMessaging</code>
<div><span class="hint">service in module <code ng:non-bindable="">itesoft</code>
<code ng:non-bindable=""><a target="_blank" href="https://github.com/alizarion/angular-common/releases/tag/v1.2"> since v1.2</a></code>
</span>
</div>
</h1>
<div><h2 id="description">Description</h2>
<div class="description"><div class="itesoft-service-page itesoft-service-itmessaging-page"><p>Service that provide all functions to connect and  dialog with itesoft-messaging system.</p>
<table class="table">
<tr>
    <th>Property</th>
    <th>Default value</th>
    <th>Description</th>
</tr>

<tr>
    <td><code>ItMessagingProvider.SERVICE_URL = &#39;Your itesoft-messaging URL&#39;;</code></td>
    <td>&#39;&#39;</td>
    <td>angular.module(&#39;myModule&#39;)<br>.config([&#39;ItMessagingProvider&#39;, function(ItMessagingProvider) {<br>
     ItMessagingProvider.SERVICE_URL = &#39;tstbuydpoc01:3333/itesoft-messaging&#39;;
     <br>
 }])</td>
</tr>
<tr>
    <td><code>Message json format</code></td>
    <td>&#39;&#39;</td>
    <td><div tabindex="-1" class="json"><span class="sBrace structure-1" id="s-1">{ <a href="javascript:;"><i class="fa fa-minus-square-o"></i></a> </span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-2">&quot;data&quot;</span><span class="sColon" id="s-3">:</span><span class="sBrace structure-2" id="s-4">{ <a href="javascript:;"><i class="fa fa-minus-square-o"></i></a> </span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-5">&quot;youBusinessKey&quot;</span><span class="sColon" id="s-6">:</span><span class="sObjectV" id="s-7">&quot;some&nbsp;business&nbsp;data&quot;</span><span class="sComma" id="s-8">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-9">&quot;youBusinessKey2&quot;</span><span class="sColon" id="s-10">:</span><span class="sObjectV" id="s-11">&quot;other&nbsp;business&nbsp;data&quot;</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sBrace structure-2" id="s-12">}</span><span class="sComma" id="s-13">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-14">&quot;creationDate&quot;</span><span class="sColon" id="s-15">:</span><span class="sObjectV" id="s-16">&quot;2016-05-31T15:15:14.436+0000&quot;</span><span class="sComma" id="s-17">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-18">&quot;from&quot;</span><span class="sColon" id="s-19">:</span><span class="sObjectV" id="s-20">&quot;senderID&quot;</span><span class="sComma" id="s-21">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-22">&quot;notification&quot;</span><span class="sColon" id="s-23">:</span><span class="sBrace structure-2" id="s-24">{ <a href="javascript:;"><i class="fa fa-minus-square-o"></i></a> </span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-25">&quot;title&quot;</span><span class="sColon" id="s-26">:</span><span class="sObjectV" id="s-27">&quot;notification&nbsp;title&nbsp;&quot;</span><span class="sComma" id="s-28">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-29">&quot;body&quot;</span><span class="sColon" id="s-30">:</span><span class="sObjectV" id="s-31">&quot;notification&nbsp;body&quot;</span><span class="sComma" id="s-32">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-33">&quot;icon&quot;</span><span class="sColon" id="s-34">:</span><span class="sObjectV" id="s-35">&quot;some-icon-to-render&quot;</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sBrace structure-2" id="s-36">}</span><span class="sComma" id="s-37">,</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sObjectK" id="s-38">&quot;to&quot;</span><span class="sColon" id="s-39">:</span><span class="sBracket structure-2" id="s-40">[ <a href="javascript:;"><i class="fa fa-minus-square-o"></i></a> </span><br><span>&nbsp;&nbsp;&nbsp;</span><span>&nbsp;&nbsp;&nbsp;</span><span class="sArrayV" id="s-41">&quot;/topic/topicGroup:topicName&quot;</span><br><span>&nbsp;&nbsp;&nbsp;</span><span class="sBracket structure-2" id="s-42">]</span><br><span class="sBrace structure-1" id="s-43">}</span></div></td>
</tr>
<tr>
 <td>service constructor  var itmsg = new ItMessaging(BASE_URL);</td>
 <td>&#39;&#39;</th>
 <td>new ItMessaging(BASE_URL), BASE_URL of your itesoft-messaging backend service without protocol ex: localhost:8080/itesoft-messaging </td>
</tr>
<tr>
    <td> itmsg.connect(token);</td>
    <td>&#39;&#39;</td>
    <td>to establish a websocket connexion with itesoft-messaging service, using the token that have returned by your backend using his api key </td>
</tr>
<tr>
    <td>itmsg.subscribeToTopic(&#39;/topic/&#39;+topicName,observers)</td>
    <td>&#39;&#39;</td>
    <td>return promise, method to subscribe some users(observers) to topic ,<br>
        if topic does not exist, it will be automatically created<br>
        if you try to subscribe observers to topic which has been created by a backend system(using api key not with token) you will get and error.<br>
        commonly if your topic is conversation between observer, use the &quot;/topic/conversation:&quot; key to start naming it.
     </td>
</tr>
<tr>
    <td>itmsg.unSubscribeToTopic(&#39;/topic/&#39;+topicName,observers)</td>
    <td>&#39;&#39;</td>
    <td>return promise, method to unsubscribe some users(observers) from topic ,<br>
        if you try to unsubscribe observers to topic which has been created by a backend system(using api key not with token) you will get and error.<br>
        observers that has been registred to topic using api key, can be unregistred using api key not a token.
     </td>
</tr>
<tr>
    <td>itmsg.onClose(callbackFunction(event)</td>
    <td>&#39;&#39;</td>
    <td>
        callback function will be triggered where websocket connexion is interupted.
     </td>
</tr>

<tr>
    <td>itmsg.onMessage(callbackFunction(message,topics)</td>
    <td>&#39;&#39;</td>
    <td>
       callback function is triggered when message arrive, they will pass 3 arguments, message that has been received <br>
       and topics, that represent list of the topics that the user have subscribe.
     </td>
</tr>

</table></div></div>
<h2 id="dependencies">Dependencies</h2>
<ul class="dependencies"><li><code ng:non-bindable=""><a href="#/api/ng.$websocket">$websocket</a></code>
</li>
<li><code ng:non-bindable=""><a href="#/api/ng.$log">$log</a></code>
</li>
<li><code ng:non-bindable=""><a href="#/api/ng.$q">$q</a></code>
</li>
</ul>
<h2 id="example">Example</h2>
<div class="example"><div class="itesoft-service-page itesoft-service-itmessaging-page"><h4 id="example_source">Source</h4>
<div source-edit="itesoft" source-edit-deps="angular.js Controller.js" source-edit-html="index.html-23" source-edit-css="" source-edit-js="Controller.js" source-edit-json="" source-edit-unit="" source-edit-scenario=""></div>
<div class="tabbable"><div class="tab-pane" title="index.html">
<pre class="prettyprint linenums" ng-set-text="index.html-23" ng-html-wrap-loaded="itesoft angular.js Controller.js"></pre>
<script type="text/ng-template" id="index.html-23">
         <div  style="height:600px !important;" ng-controller="MainController as main">
             <div class="row-height-1">
             <div ng-if="main.username">
             <h5  id="example_source_hi-@{{mainusername}}">hi @{{main.username}}</h5>
             <p>Use @Username to chat with other users</p>
             </div>
             </div>
             <div class="row row-height-9" ng-if="main.isConnected">
             <div class="col-md-6 col-xs-6  it-fill">
             <div class="col-xs-12 jumbotron  it-fill">
             {{main.selectedTopic}}
             </div>
             </div>
             <div class="col-md-6 col-xs-6  it-fill">
             <div class="col-xs-12 jumbotron  it-fill">
             <div class="row-height-2 " style=" overflow-x: scroll!important;">
             <div>
             <div class="pull-left it-messaging-tag label label-info">
             <a href=""  ng-click="main.selectCurrentTopic(null)">all</a>
             </div>

             <div class="pull-left it-messaging-tag label label-info" ng-repeat="t in main.topics |topic:t.address  ">
             <a href=""  ng-click="main.selectCurrentTopic(t)">{{t.address | conversation:main.username}}</a><a href="" ng-click="main.unSubscribe(t.address)">  x</a>
             </div>
             </div>

             </div>
             <div class="row-height-8 "  id="conversation-content"  style="overflow:auto;margin-top: -30px;background-color:white;">
             <div ng-repeat="m in main.messages | orderBy: 'creationDate':false">
             <div class="it-messaging-message" ng-if="main.selectedTopic ? m.to.indexOf('/topic/'+main.selectedTopic.address)>=0 :true">
             <div class="it-messaging-chat" ng-if="m.data.message" ng-class="{mine :(main.username==m.from) ,others : (main.username!=m.from) }">
             <span class="sender"> @{{m.from}} :</span>
             <span class="message-text">{{m.data.message}}</span>

             </div>
             <div ng-if="!m.data.message">
             <span ng-if="m.notification"><i class="fa fa-{{m.notification.icon}}"></i>  {{m.notification.body}} </span>
             </div>

             <div class="small">{{m.creationDate | date:'yyyy-MM-dd HH:mm'}}</div>
             </div>
             </div>
             </div>
             <div class="row-height-2 ">
             <form  novalidate name="messageForm" ng-submit="main.sendMessage(main.$textMessage)">
             <input ng-model="main.$textMessage" name=""  style="width : 100%">

             </form>
             </div>
             </div>
             </div>
             </div>

             <div class="row row-height-6" ng-if="!main.isConnected">
             <div class="col-md-6  col-xs-6 col-xs-offset-3 col-md-offset-3 jumbotron  it-fill">
             <br>
             <form class="form-group"  novalidate name="myForm" ng-submit="main.login(username)">
             <div class="form-group">
             <input it-input class="form-control floating-label"
             disabled="true"
             type="text"
             it-label="API URL"
             ng-model="main.BASE_URL">
             </div>
             <div class="form-group">
             <input it-input class="form-control floating-label"
             disabled="true"
             type="text"
             it-label="API KEY"
             ng-model="main.API_KEY">
             </div>
             <div class="form-group">
             <input it-input class="form-control floating-label"
             required=""
             ng-maxlength="10"
             type="text"
             it-label="Username"
             name="Username"
             ng-model="username">
             </div>
             <button class="btn btn-primary" type="submit">Sign in</button>
             </form>
             </div>

             </div>

             <toast class="toaster" style="left:0px !important; bottom:0px !important"></toast>

         </div>
     </script>
</div>
<div class="tab-pane" title="Controller.js">
<pre class="prettyprint linenums" ng-set-text="Controller.js"></pre>
<script type="text/ng-template" id="Controller.js">
             angular.module('itesoft')
             .filter('conversation',[ function() {
                return function(input,args) {
                  var result ='';
                  var stringResult = '';
                  if(input.startsWith('conversation:')){
                    input = input.replace('conversation:','');
                    input = input.replace(args+':','');
                      input = input.replace(args,'');
                    result =  input.split(':');
                    angular.forEach(result,function(entry){
                        stringResult = stringResult + ' ' +entry;
                    })
                    return stringResult;
                  }

                  return input;
                };
                }]).config(['ItMessagingProvider', function(ItMessagingProvider) {
                    ItMessagingProvider.SERVICE_URL = 'tstbuydpoc01:3333/itesoft-messaging';
                }])
                 .filter('topic',[ function() {
                    return function(input) {

                      var result = [];
                      if(input){
                        angular.forEach(input, function(entry){
                              if(entry.address.startsWith('conversation:')){
                                result.push(entry);
                              }

                        });

                        return result;
                      }
                      return input;
                    };
                }])
                 .controller('MainController',['ItMessaging','itNotifier','$scope',function(ItMessaging,itNotifier,$scope){

                  var self = this;
                  var itmsg = new ItMessaging();
                  self.BASE_URL = itmsg.getServiceUrl();
                  self.SHOWCASE_TOPIC = "group:all";
                  self.API_KEY = 'my-secret-api-key';


                  self.messages = [];
                  self.topics = [];
                  self.selectedTopic = null;
                  self.username = null;

                  function Message(messageText){
                    this.to = [];
                    this.data =  {
                      "message" : messageText
                    };
                    this.notification = {
                      title: self.username + ' sent you a message',
                      body : self.username + ' sent you a message',
                      icon : 'comment-o'
                    }
                  }

                  self.isConnected = false;
                  self.username = null;

                  itmsg.onMessage(function(message,topics){
                    self.topics = topics;

                    self.messages.push(message);

                    _scrollToBottom();
                  });

                  itmsg.onClose(function(event){
                     itNotifier.notifyError({
                                content: "Error popup",
                                dismissOnTimeout: false
                            },
                            {
                                CODE:500,
                                TYPE:'error',
                                MESSAGE:'Something bad happened',
                                DETAIL:'You don\'t wanna know',
                                DONE:1
                            });

                     self.isConnected = false;
                  });

                  this.login = function(username){
                    self.username = username;
                    itmsg.getToken(self.API_KEY ,username).then(function(token){
                     self.isConnected = itmsg.connect(token);
                     itmsg.subscribeToTopic(self.SHOWCASE_TOPIC,[{id : self.username}]);
                    });
                  }

                  this.sendMessage = function(messageText){
                    var m = new Message(messageText);
                    var r =  _textMessageExtractor(messageText);
                    var topicName = null;
                    if(r.topicName){
                      topicName =r.topicName;
                    } else if(self.selectedTopic) {
                       topicName =self.selectedTopic.address;
                    } else {
                      topicName = self.SHOWCASE_TOPIC;
                    }
                    m.to.push('/topic/'+topicName);
                    itmsg.subscribeToTopic(topicName,r.observers)
                        .then(function(ok){
                             itmsg.sendMessage(m);
                    });
                    self.$textMessage = '';
                  }

                  this.selectCurrentTopic = function(topic){
                    self.selectedTopic = topic;
                  }

                  this.unSubscribe = function(topicName){
                    itmsg.unsubscribeToTopic(topicName,[{id : self.username }])
                  }


                  function _textMessageExtractor(messageText){
                        var regex = new RegExp(/(^|[^@\w])@(\w{1,15})\b/g);
                 var myArray;
                 var users = [];
                 var result = {
                            observers : [],
                            topicName : null
                        };
                 while ((myArray = regex.exec(messageText)) != null)
                 {
                   users.push(myArray[2])
                 }
                 users.sort();
                 if(users.length > 0){
                          result.topicName = 'conversation:'+ self.username;
                            for ( var user  in  users){
                              result.topicName = result.topicName + ':' + users[user];
                              result.observers.push(
                                {
                                'id' : users[user]
                                }
                            );
                            }
                            result.observers.push({
                              'id': self.username
                            });
                    }
                 return result;
                 }


                 function _scrollToBottom(){
                     setTimeout(function() {
                      var scroller = document.getElementById('conversation-content');
                      scroller.scrollTop = scroller.scrollHeight;
                    },250);
                  }

                 }])
     </script>
</div>
</div><h4 id="example_demo">Demo</h4>
<div class="well doc-example-live animate-container" ng-embed-app="itesoft" ng-set-html="index.html-23" ng-eval-javascript="Controller.js"></div>
</div></div>
</div>
